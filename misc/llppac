#!/bin/sh
set -e

font=$HOME/x/fnt/LastResort.ttf
! test -r $font || export LLPP_FALLBACK_FONT=$font

die() {
    echo "$1" >&2
    exit 1
}

cachedir="$HOME/.cache/llpp"
test -d "$cachedir" || die "cache directory '$cachedir' does not exist"

caspsuf=
type=

executable_p() { command -v "$1" >/dev/null 2>&1; }

missing() {
    executable_p $1 || \
        eval "$1() { die \"$2 is needed for \$type conversion\"; }"
}

text() {
    cat <<EOF
<pre style="font-size: ${1}pt;">
$1 <hr>
EOF
    test -n "$2" && cat $2 || cat <<EOF
S9 Ğ—3Ó Ê’ I|l1 O0 0O o0 0o OD DO Oo Do m rn m -~ ~-  8B B8 BB 88B8 88B8

abcdefghijklmnopqrstuvwxyz
ABCDEFGHIJKLMNOPQRSTUVWXYZ
Ğ°Ğ±Ğ²Ğ³Ğ´ĞµÑ‘Ğ¶Ğ·Ğ¸Ğ¹ĞºĞ»Ğ¼Ğ½Ğ¾Ğ¿Ñ€ÑÑ‚ÑƒÑ„Ñ…Ñ†Ñ‡ÑˆÑ‰ÑÑÑ
ĞĞ‘Ğ’Ğ“Ğ”Ğ•ĞĞ–Ğ—Ğ˜Ğ™ĞšĞ›ĞœĞĞĞŸĞ Ğ¡Ğ¢Ğ£Ğ¤Ğ¥Ğ¦Ğ§Ğ¨Ğ©Ğ­Ğ®Ğ¯
Ğ¸Ğ½Ğ¿Ğ¸Ğ¿Ğ½Ğ¸ÑˆĞ¿Ğ½Ğ¸Ğ¿ÑˆĞ½Ğ¸Ğ¿Ğ½Ğ¿Ğ½ÑˆĞ¿Ğ½Ğ¿Ğ¸Ğ½Ğ¿Ğ¸Ğ¿Ğ½Ğ¿Ğ¸Ğ¿Ñ‰Ğ½Ğ¿Ğ¸Ğ¿Ğ¸Ğ¿Ğ¸Ğ½
Ğ¸Ğ½Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¸Ğ²Ğ° ÑˆĞ¸Ğ¾Ñ€Ğ¾ĞºĞ¾ÑˆĞ°Ñ€Ğ¸ĞºĞ¾Ğ¿Ğ¾Ğ´ÑˆĞ¸Ğ¿Ğ½Ğ¸ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ²Ğ·Ğ±Ğ·Ğ´Ğ½ÑƒÑ‚ÑŒ Ğ³Ğ¸Ğ´Ñ€Ğ¾Ğ°ÑÑ€Ğ¾Ğ¸Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
Ñ‚ĞµĞ»ĞµĞ³Ğ°Ğ¼Ğ¼Ğ°Ğ°Ğ¿Ğ¿Ğ°Ñ€Ğ°Ñ‚ Ñ„ĞµĞ»ÑŒĞ´ÑŠĞµĞ³ĞµÑ€ÑŒ Ñ‡ĞµÑ‚Ñ‹Ñ€Ñ‘Ñ…ÑĞ¾Ñ‚Ğ¿ÑÑ‚Ğ¸Ğ´ĞµÑÑÑ‚Ğ¸ÑĞµĞ¼Ğ¸Ğ¼Ğ¸Ğ»Ğ»Ğ¸Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²Ğ¾Ğµ
Ğ¿Ñ€ĞµĞ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ°ÑÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ²ÑĞºĞ¾Ğ»ÑŒĞ·ÑŒ Ğ·Ğ°Ğ±ÑƒĞ»Ğ´Ñ‹Ğ¶Ğ½Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
Ñ†ĞµÑ†ĞµÑ†Ğ½Ğ¸Ñ†Ğ°
https://ru.wikipedia.org/wiki/ĞŸĞ°Ğ½Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° https://en.wikipedia.org/wiki/Pangram
Ğ­ĞºÑ-Ğ³Ñ€Ğ°Ñ„? ĞŸĞ»ÑÑˆ Ğ¸Ğ·ÑŠÑÑ‚. Ğ‘ÑŒÑ‘Ğ¼ Ñ‡ÑƒĞ¶Ğ´Ñ‹Ğ¹ Ñ†ĞµĞ½ Ñ…Ğ²Ğ¾Ñ‰!
Waltz, bad nymph, for quick jigs vex
',.áƒ¤yfáƒ’cáƒ áƒšáƒáƒáƒ”áƒ£áƒ˜áƒ“áƒ°áƒ—áƒœáƒ¡áƒ§áƒ¯áƒ¥xáƒ‘áƒ›wáƒ•áƒ–
Î£Î¿Î¼Îµ Ï€ÏƒÎ¸Î´Î¿ Î³ÏÎµÎµÎº
à½–à½¦à¾à½´à½¢à¼‹à½¡à½²à½‚à¼‹à½˜à½‚à½¼à¼‹
Il1| Il|1 I1l| I1|l I|1l I|l1 lI1| lI|1 l1I| l1|I l|1I l|I1
1lI| 1l|I 1Il| 1I|l 1|Il 1|lI |l1I |lI1 |1lI |1Il |I1l |Il1
\`1234567890-=\\
~!@#\$$%&permil;^&amp;*()_+|
â‚¹â‚½Â£$â‚¬
[];',.//|/\ &gt;- -&gt; ~~&lt; &lt;-- --&gt; == === ==&gt; &lt;==
{}:"&lt;&gt;?" Januardo90 repo2obj
S in S9 59 S9 is like 5 also
final fjord flair ft fff
3Ğ—Ğ­ÑĞ·ÑÑĞ·3Ğ—qgO0o ijklI1| bgqpykvwlliliiijil1 lLLl
01234567890 3Ğ”Ğ¡ Ğ—Ğ”Ğ¡ Ó Ğ”Ğ¡ Ê’Ğ”Ğ¡ NYX - ĞŸĞ£Ğ¥
rnrmnnmrrrnmmr <i>NÃ¼rnberg</i> (rn -> m)
Apay ĞÑ€Ğ°Ñƒ
Ã¶rÃ¶k fÃ¼r AÌ‹ aÌ‹ Å‘ Å± https://en.wikipedia.org/wiki/Diacritic
https://en.wikipedia.org/wiki/Double_acute_accent
Latin
AÌ‹ aÌ‹
EÌ‹ eÌ‹
IÌ‹ iÌ‹
MÌ‹ mÌ‹
Å Å‘
Å° Å±
Cyrillic
Ó² Ó³
Ğ¼Ğ¾Ğ»Ğ¾Ğ´Ğ¾ÌĞ¹
- - (~-) ~ ~ (-~) -- ~~ ~&mdash; &mdash;~ ''"''""., 1.65Mb
curly vs plain braces {} () {} ({ {( }) )} â†’
Bjarne Stroustrup (/ËˆbjÉ‘ËrnÉ™ ËˆstraÊŠstrÊŠp/; Danish: [ËˆbjÉ‘ËnÉ™ ËˆsdÊÊŒwË€sdÊÉ”b]
â—‹â—ğŸ…¼î”€ğŸ«ğŸ§ï·½ğŸ™‹âœ¨ğŸŒ¸
ğŸ˜ ğŸ˜‚ ğŸ˜ƒ ğŸ˜… ğŸ˜† ğŸ˜‡ ğŸ˜ˆ ğŸ˜‰ ğŸ˜Š ğŸ˜‹ ğŸ˜Œ ğŸ˜ ğŸ˜ ğŸ˜ ğŸ˜ ğŸ˜‘
ğŸ˜’ ğŸ˜“ ğŸ˜• ğŸ˜— ğŸ˜˜ ğŸ˜™ ğŸ˜š ğŸ˜› ğŸ˜œ ğŸ˜ ğŸ˜  ğŸ˜¡ ğŸ˜¢ ğŸ˜¥ ğŸ˜§ ğŸ˜¨
ğŸ˜© ğŸ˜ª ğŸ˜« ğŸ˜¬ ğŸ˜­ ğŸ˜® ğŸ˜¯ ğŸ˜° ğŸ˜± ğŸ˜² ğŸ˜³ ğŸ˜µ ğŸ˜¶ ğŸ˜¸ ğŸ˜¹ ğŸ˜»
ğŸ˜¼ ğŸ˜½ ğŸ˜¾ ğŸ˜¿ ğŸ™€ ğŸ™ ğŸ™‚ ğŸ™ƒ ğŸ™„ ğŸ™† ğŸ™‡ ğŸ™‰ ğŸ™Š ğŸ™Œ ğŸ™ ğŸ™
ğŸ™ ğŸ˜€ ğŸ˜€ ğŸ˜¡ ğŸ˜¤ ğŸ˜¦ ğŸ˜– ğŸ˜„ ğŸ˜” ğŸ™… ğŸ™ˆ ğŸ™‹ ğŸ˜  ğŸ˜§ ğŸ˜Ÿ ğŸ˜´
ğŸ˜· ğŸ˜º ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ˜£ ğŸ¤­ âœ‰ ğŸ“§

kerning
    echo \${@:5}
    life           [l i fe]
    lambdabot      [l a mb]
    Commutative    [Co mm utative]
    weird          [we i rd]
    Before         [Bef ore, Be for e]
    higher         [gh, h i gher, hi gher]
    multi          [mu lti]
    till           [ti ll]
    language       [an]
    plan           [la]
    when           [wh]
    kerning        [rn | ng]
    Ğ¼Ğ½Ğµ            [Ğ¼Ğ½ Ğµ]
    oiled          [oi led]
    mkfifo         [mk f i fo, mk f i fo]
    didn't         [di dn't]
    argumnet (sic) []
    more           [mo re]
    CmmCall        [CmmC a l l]
    -Wvla          [-Wv la]
    align          [a l i gn]
    Compiling      [Co mp iling]
    print          [pr int]
    fcmono         [f cmono]
    Mail           [M ail]
    xsrc           [x src]
    Pokorna
    buildglyphs.js [buil dg lyphs]
    Dollar         [Do ll ar]
    signed         [s i gned]
    Pine           [Pi ne]
    right          [r i ght, ri ght]
    ugliness
    Nigeria        [Ni g eria]
    Nothing        [Nothi ng]
    modify         [mo dify]
    mplus          [mp lus]
    Apostolic      [A postolic]
    ĞºĞ¾Ğ´Ğµ           [Ğº Ğ¾ Ğ´Ğµ]
    ĞŸÑ€Ğ¾ĞºĞ¾Ñ„ÑŒĞµĞ²Ğ½Ñƒ    [ĞŸÑ€Ğ¾ ĞºĞ¾ Ñ„ÑŒĞµĞ²Ğ½Ñƒ]
    Ğ¥ÑĞ»Ğ¿           [X ÑĞ»Ğ¿]
    ĞºĞ¾ÑĞ½ÑƒĞ»ÑÑ       [ĞºĞ¾ ÑĞ½ÑƒĞ»ÑÑ]
    Ğ¾Ğ±ÑŒÑĞ²Ğ»ÑĞ½Ñ‹Ğ¼     [Ğ¾Ğ± ÑŒÑ Ğ²Ğ»ĞµĞ½Ñ‹Ğ¼]
    Queen          [Qu een]
    etymological   [et ymological]
    sigh           [s i gh]
    git            [gi t]
    Ğ½ĞµĞºĞ¾Ñ‡ĞµĞ²Ğ¾Ğ³Ğ¾     [Ğ½Ğµ ĞºĞ¾ Ñ‡ĞµĞ²Ğ¾Ğ³Ğ¾]
    Ğ Ğ¾Ğ·Ğ¾Ğ²Ğ¾Ğµ        [Ğ Ğ¾ Ğ·Ğ¾ Ğ²Ğ¾Ğµ]
    Trump          [Tru mp]
    Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ       [Ğ¿Ğ¾ ĞºÑ€ Ñ‹Ñ‚Ğ¸Ğµ]
    Singapore      [Si ng apore]
    Georgy         [Ge orgy]
    with           [wi th]
    Yokozuna       [Y okozuna]
    Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ  [Ğ¿Ğ¾Ğ´ Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ]
    Xwayland       [X wayland]
    callable       [ca l l ab le]
    Noah           [N oa h]
    Los            [L os]
    refused        [ref used]
    Julia          [J ulia | Jul i a]
    Joe Armstrong  [J oe (rip :()]
    James          [J ames]
    CAPTCHA        [CA PTCHA]
    KIZER          [KI ZER]
    Kavanugh       [K avaunaugh]
    DejaVu         [D e ja V u]
    Never          [N ever]
    Ğ¤Ğ¸Ğ»Ğ°Ğ½Ñ‚Ñ€Ğ¾Ğ¿Ğ¸Ñ    [Ğ¤Ğ¸ Ğ»Ğ°Ğ½Ñ‚Ñ€Ğ¾Ğ¿Ğ¸Ñ]
    Ğ¡Ğ¼ĞµÑ€Ñ‚Ğ½Ğ°Ñ       [Ğ¡Ğ¼ Ğµ Ñ€ Ñ‚ Ğ½ Ğ° Ñ]
    1530           [1 53 0]
    Japanese       [J apanese]
    Ñ†Ğ¸Ğ½Ğ¸ĞºĞ¾Ğ²        [Ñ†Ğ¸ Ğ½Ğ¸ ĞºĞ¾Ğ²]
    Viljandi       [Vil ja ndi]
    rejected       [re je cted]
    Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼     [Ğ¿Ğ¾ ÑĞ² Ğ»ĞµĞ½Ğ¸ĞµĞ¼]
    ĞšĞ¾Ñ€Ğ¾Ğ½Ğ°Ğ²Ğ¸Ñ€ÑƒÑĞ°   [ĞšĞ¾ Ñ€Ğ¾Ğ½Ğ°Ğ²Ğ¸Ñ€ÑƒÑĞ°]
    efficacy       [e f fi cacy]
    ĞŸĞ¾ĞµĞ·Ğ´          [ĞŸ Ğ¾Ğµ Ğ·Ğ´]
    ĞÑ€ÑĞµĞ½Ğ¸Ñ        [Ğ Ñ€ÑĞµĞ½Ğ¸Ñ]
    rmnp           []

almost kerning
    hope doesn't
    Illegal
    automatically effective
    Ilium is the Latin for Ilion.
    jtanx
    Pizza Tteokbokki
    Lorry

(from UTF8-demo.txt)
Box drawing alignment tests:                                          â–ˆ
                                                                      â–‰
  â•”â•â•â•¦â•â•â•—  â”Œâ”€â”€â”¬â”€â”€â”  â•­â”€â”€â”¬â”€â”€â•®  â•­â”€â”€â”¬â”€â”€â•®  â”â”â”â”³â”â”â”“  â”â”’â”â”‘   â•·  â•» â”â”¯â”“ â”Œâ”°â”    â–Š â•±â•²â•±â•²â•³â•³â•³
  â•‘â”Œâ”€â•¨â”€â”â•‘  â”‚â•”â•â•§â•â•—â”‚  â”‚â•’â•â•ªâ•â••â”‚  â”‚â•“â”€â•â”€â•–â”‚  â”ƒâ”Œâ”€â•‚â”€â”â”ƒ  â”—â•ƒâ•„â”™  â•¶â”¼â•´â•ºâ•‹â•¸â” â”¼â”¨ â”â•‹â”¥    â–‹ â•²â•±â•²â•±â•³â•³â•³
  â•‘â”‚â•² â•±â”‚â•‘  â”‚â•‘   â•‘â”‚  â”‚â”‚ â”‚ â”‚â”‚  â”‚â•‘ â”ƒ â•‘â”‚  â”ƒâ”‚ â•¿ â”‚â”ƒ  â”â•…â•†â”“   â•µ  â•¹ â”—â”·â”› â””â”¸â”˜    â–Œ â•±â•²â•±â•²â•³â•³â•³
  â• â•¡ â•³ â•â•£  â”œâ•¢   â•Ÿâ”¤  â”œâ”¼â”€â”¼â”€â”¼â”¤  â”œâ•«â”€â•‚â”€â•«â”¤  â”£â”¿â•¾â”¼â•¼â”¿â”«  â”•â”›â”–â”š     â”Œâ”„â”„â” â• â”â”…â”…â”“ â”‹ â– â•²â•±â•²â•±â•³â•³â•³
  â•‘â”‚â•± â•²â”‚â•‘  â”‚â•‘   â•‘â”‚  â”‚â”‚ â”‚ â”‚â”‚  â”‚â•‘ â”ƒ â•‘â”‚  â”ƒâ”‚ â•½ â”‚â”ƒ  â–‘â–‘â–’â–’â–“â–“â–ˆâ–ˆ â”Š  â”† â• â•  â”‡ â”‹ â–
  â•‘â””â”€â•¥â”€â”˜â•‘  â”‚â•šâ•â•¤â•â•â”‚  â”‚â•˜â•â•ªâ•â•›â”‚  â”‚â•™â”€â•€â”€â•œâ”‚  â”ƒâ””â”€â•‚â”€â”˜â”ƒ  â–‘â–‘â–’â–’â–“â–“â–ˆâ–ˆ â”Š  â”† â• â•  â”‡ â”‹ â–
  â•šâ•â•â•©â•â•â•  â””â”€â”€â”´â”€â”€â”˜  â•°â”€â”€â”´â”€â”€â•¯  â•°â”€â”€â”´â”€â”€â•¯  â”—â”â”â”»â”â”â”›  â–—â–„â––â–›â–€â–œ   â””â•Œâ•Œâ”˜ â• â”—â•â•â”› â”‹  â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ
                                               â–â–€â–˜â–™â–„â–Ÿ

https://mirrors.zju.edu.cn/CTAN/fonts/gofonts/doc/gofonts.pdf (page 2)
"""
DIN Legibility Standard

The recent German DIN 1450 legibility standard
recommends several features for font legibility, including
differentiation of letter shapes to reduce confusion. The Go fonts
conform to the 1450 standard by carefully differentiating zero from
capital O; numeral 1 from capital I (eye) and lowercase l (ell);
numeral 5 from capital S; and numeral 8 from capital B. The shapes of
bowls of b d p q follow the natural asymmetries of legible Renaissance
handwriting, aiding differentiation to reduce confusion. [5]
"""

(https://en.wikipedia.org/wiki/Jabberwocky
 Idea from the aforementioned gofonts paper)

    Ğ‘Ğµ ÑĞ³Ğ»Ğ°Ğ´Ğ½Ğµ Ğ¸ Ñ‡ĞµÑÑ‚Ğ»Ğ¸Ğ½Ğ½Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ±ÑƒÑ€ÑĞ¸  ÃaÃ° leiÃ° aÃ° stekju, og slÃ½gir greÃ°lar
    Ñ‚ÑŠÑ€Ğ»ÑÑ…Ğ° ÑĞµ Ğ¸ ÑĞ²Ñ€ĞµÑ†Ğ²Ğ°Ñ…Ğ° Ğ²ÑŠĞ² Ğ¿Ğ»Ğ¸Ñ‚Ğµ;  sig snÃ¦ldu og bÃ¶luÃ°u um slÃ¶ffruna,
    ÑÑŠĞ²ÑĞµĞ¼ Ğ¾ĞºĞ»Ğ°ÑĞ½Ğ¸ Ğ±ÑÑ…Ğ° Ñ‚ÑƒĞº Ñ‰ÑƒÑ€Ğ¿Ğ¸Ñ‚Ğµ    og angurvÃ¦rt sungu sÃ³pfiÃ°rungar
    Ğ¸ Ğ¾Ñ‚Ğ¼Ğ° Ñ€Ğ°Ğ²Ğ°Ğ¿ÑĞ°Ñ‚Ğ²Ğ°Ñ…Ğ° Ğ¿Ñ€Ğ°ÑÑƒÑ€ÑĞ¸.      viÃ° sÃ­fgelt tÃ½Ã°mana svÃ­rÃ¦na.

(https://en.wikipedia.org/wiki/Typeface)
For the rational mind, type design can be a maddening game
of drawing things differently in order to make them appear the
same.
Jonathan Hoefler & Tobias Frere-
</pre>
EOF
}

maketext() {
    # https://github.com/react-boilerplate/react-boilerplate/issues/1340
    test -d "$cachedir/fonts" || mkdir "$cachedir/fonts"
    filename="$(basename "$1")"
    textfilename="$2"
    cat >"$cachedir/fonts/text.html" <<EOF
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>$filename</title>
    <style type="text/css">
      @font-face { font-family: moo; src: url('$1'); }
      pre { font-family: moo; }
    </style>
  </head>
  $filename
  <body>
EOF
    for size in 6 8 10 12 4 2; do
        text $size $textfilename >>"$cachedir/fonts/text.html"
    done
    cat >>"$cachedir/fonts/text.html" <<EOF
    <br/>
    $(fc-scan -f '%{fullname} %{style} %{slant} %{file} %{fontversion} %{capability} %{lang}' "$1" || file "$1")
  </body>
</html>
EOF
}

trap 'test -n "$casp" && rm -f "$casp"' 0

while getopts s:c:m:t:fu opt; do
    case $opt in
        m) mime=$OPTARG;;
        t) type=$OPTARG;;
        f) force=true;;
        c) css="-s $OPTARG";;
        s) textfilename="$OPTARG";;
        ?) die "usage: $0 [-c css] [-m mime/type] [-t filter] [-f] [-s textfile] [path|url]";;
    esac
done
shift $(($OPTIND - 1))
test -z "$1" && die "usage $0: path"

origin="$1"
if ${force-test ! -e "$1"} && expr >/dev/null "$1" : "\(ftp\|https\?\)://"; then
    if executable_p wget; then
        dl() { wget -q $1 -O $2; }
    elif executable_p curl; then
        dl() { curl -L $1 -o $2; }
    else
        die "no program to fetch remote urls found"
    fi

    hashof="$cachedir/$(basename "$1")"
    dl "$1" "$hashof" || test -e "$md5of"
    shift
    set -- "$hashof" "$@"
else
    hashof="$1"
fi

test -z "$type" && { ft=$(file -L --mime-type -b "$1") || die "$ft"; }

case $ft in
    application/x-gzip | application/x-compress) dc=zcat;;
    application/x-xz) dc=xzcat;;
    application/x-bzip2) dc=bzcat;;
    *) unset dc || true;;
esac

filt='"${dc-cat}" "$1" |'

typeofmime() {
    case "$1" in
        application/postscript) type=ps;;
        application/pdf) type=pdf;;
        image/vnd.djvu) type=djvu;;
        text/html) type=html;;
        text/plain) type=text;;
        application/msword) type=word;;
        application/vnd.openxmlformats-officedocument.*  \
            | application/vnd.ms-powerpoint              \
            | application/vnd.ms-excel                   \
            | application/vnd.oasis.opendocument.*) type=uno;;
        image/svg+xml) type=svg;;
        image/png | image/jpeg) test -n "$dc" && type="image" || type="image2";;
        image/*) type=image;;
        application/x-dvi) type=dvi;;
        application/x-font-ttf                  \
            | application/vnd.ms-opentype       \
            | application/font-sfnt) type=font;;
        *) return 1;;
    esac
    return 0
}

if test -z "$type"; then
    test -z "$mime" &&                                          \
        mime=$(file -L --mime-type -b "$1" || die "$mime") ||   \
            $(file -L --mime-type -bz "$1" || die "$mime")
    typeofmime "$mime" || die "unhandled file type: '$mime'"
fi

caspsuf=".pdf"
case $type in
    ps) conv='ps2pdf - "$casp"';;
    image2|pdf) test -z "$dc" && exec llpp "$@" || conv='cat >"$casp"';;
    texi) {
        missing texi2html "texi2html(http://www.nongnu.org/texi2html/)"
        missing prince "PrinceXML(http://www.princexml.com/)"
        conv='texi2html - -o - | prince $css - -o "$casp"'
    };;
    djvu) {
        missing ddjvu "ddjvu(http://djvu.sourceforge.net/doc/man/ddjvu.html)"
        conv='ddjvu -format=pdf - "$casp"'
    };;
    html) {
        missing prince "Prince(http://www.princexml.com/)"
        conv='prince $css - -o "$casp"'
    };;
    html2epub) {
        missing pandoc "pandoc(http://pandoc.org)"
        caspsuf=".epub"
        conv='pandoc -r html - -w epub2 -o "$casp"'
    };;
    word) {
        if executable_p unoconv && test -z "$dc"; then
            unset filt
            conv='unoconv -o "$casp" "$1"'
        else
            missing antiword "antiword or unoconv"
            conv='antiword -m 8859-1.txt -a a4 - >"$casp"'
        fi
    };;
    uno) {
        test -n "$dc" && die "cannot convert compressed '$mime'"
        unset filt
        missing unoconv "unoconv(http://dag.wiee.rs/home-made/unoconv/)"
        conv='unoconv -o "$casp" "$1"'
    };;
    svg) {
        if executable_p inkscape && test -z "$dc"; then
            unset filt
            conv='inkscape -z -A "$casp" "$1"'
        else
            if executable_p rsvg-convert; then
                conv='rsvg-convert -f pdf -o "$casp"'
            else
                test -n "$dc" && die "cannot convert compressed '$mime'"
                unset filt
                missing unoconv "unoconv(http://dag.wiee.rs/home-made/unoconv/)"
                conv='unoconv -o "$casp" "$1"'
            fi
        fi
    };;
    font) {
        maketext "$1" "$textfilename"
        exec llpp -origin $1 "$cachedir/fonts/text.html"
    };;
    image) {
        missing convert "convert(http://www.imagemagick.org/script/convert.php)"
        conv='convert - pdf:"$casp"'
    };;
    dvi) {
        test -n "$dc" && die "cannot convert compressed '$mime'"
        unset filt
        missing dvipdf "dvipdf(http://ghostscript.com/)"
        conv='dvipdf "$1" "$casp"'
    };;
    text) {
        missing pandoc "pandoc(http://pandoc.org/)"
        conv='pandoc -t epub2 - -o "$casp"'
        caspsuf=.epub
    };;
    *) die "unhandled filter type: '$type'";;
esac

hash=$(cksum "$hashof") || die "$hash"
casp=$cachedir/${hash%% *}$caspsuf

{ test -n "$force" || test ! -e "$casp"; } && eval "$filt" "$conv"
shift

exec llpp -origin $origin "$@" "$casp"
